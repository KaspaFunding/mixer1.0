<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src http://127.0.0.1:8080 ws://127.0.0.1:17110; font-src 'self'; object-src 'none'; base-uri 'none'">
  <title>Kaspa Mixer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <h1>üîÑ Kaspa Mixer</h1>
      <div class="header-controls">
        <div id="node-status-indicator" class="node-status-indicator">
          <span class="status-dot"></span>
          <span id="node-status-text">Checking...</span>
          <div id="port-badges" class="port-badges"></div>
        </div>
        <button id="node-mode-toggle" class="btn btn-secondary node-mode-toggle" title="Toggle Node Mode (Public/Private)">
          <span id="node-mode-text">Private</span>
        </button>
        <button id="theme-toggle" class="theme-toggle" title="Toggle Dark Mode" aria-label="Toggle Dark Mode">üåô</button>
        <button id="node-status-btn" class="btn btn-secondary">Node Details</button>
      </div>
    </header>

    <!-- Node Status Modal -->
    <div id="node-status-modal" class="modal hidden">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>Node Status Details</h2>
          <button class="modal-close" id="close-node-modal">&times;</button>
        </div>
        <div class="modal-body" id="node-status-content">
          <div class="loading">Loading node status...</div>
        </div>
      </div>
    </div>

    <!-- Miner Detail Modal -->
    <div id="miner-modal" class="modal hidden">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>Miner Details</h2>
          <button class="modal-close" id="close-miner-modal">&times;</button>
        </div>
        <div class="modal-body" id="miner-content">
          <div class="loading">Loading miner details...</div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="sessions">Mixing Sessions</button>
        <button class="tab-btn" data-tab="create">Create Session</button>
        <button class="tab-btn" data-tab="wallet">Wallet</button>
        <button class="tab-btn" data-tab="pool">Mining Pool</button>
      </div>

      <!-- Sessions Tab -->
      <div id="sessions-tab" class="tab-content active">
        <div class="section-header">
          <h2>Active Sessions</h2>
          <button id="refresh-sessions" class="btn btn-secondary">Refresh</button>
        </div>
        
        <!-- Session Management Controls -->
        <div class="collapsible-section">
          <div class="collapsible-header" data-target="session-controls-panel">
            <h3>Session Management Controls</h3>
            <span class="collapse-icon">‚ñº</span>
          </div>
          <div class="session-controls collapsible-content" id="session-controls-panel">
            <input type="text" id="session-search" class="session-search" placeholder="Search by address, TX ID, or session ID..." />
            <div class="session-filter-group">
              <button class="session-filter active" data-filter="all">All</button>
              <button class="session-filter" data-filter="waiting">Waiting</button>
              <button class="session-filter" data-filter="deposit_received">Deposit</button>
              <button class="session-filter" data-filter="intermediate_confirmed">Confirmed</button>
              <button class="session-filter" data-filter="confirmed">Completed</button>
              <button class="session-filter" data-filter="error">Error</button>
            </div>
            <select id="session-sort" class="session-sort">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="amount-high">Amount (High to Low)</option>
              <option value="amount-low">Amount (Low to High)</option>
              <option value="status">By Status</option>
            </select>
          </div>
        </div>
        
        <div id="sessions-list" class="sessions-list">
          <div class="loading">Loading sessions...</div>
        </div>
        
        <!-- Batch Actions -->
        <div id="batch-actions" class="batch-actions hidden">
          <span id="selected-count">0 selected</span>
          <button id="batch-export" class="btn btn-secondary">Export Keys (Selected)</button>
          <button id="batch-delete" class="btn btn-danger">Delete (Selected)</button>
        </div>
        
        <div id="debug-info" class="collapsible-section hidden">
          <div class="collapsible-header" data-target="debug-content-panel">
            <h3>Debug Info</h3>
            <span class="collapse-icon">‚ñº</span>
          </div>
          <div class="collapsible-content" id="debug-content-panel">
            <pre id="debug-content"></pre>
          </div>
        </div>
      </div>

      <!-- Create Session Tab -->
      <div id="create-tab" class="tab-content">
        <form id="create-session-form" class="create-form">
          <div class="collapsible-section">
            <div class="collapsible-header" data-target="destinations-panel">
              <label style="margin: 0; font-weight: 600;">Destinations (up to 10)</label>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content" id="destinations-panel">
              <div class="form-group" style="margin-top: 0.75rem;">
                <div id="destinations-container">
                  <div class="destination-row">
                    <input type="text" placeholder="Kaspa address" class="address-input" required>
                    <input type="number" step="0.00000001" min="0.00001" placeholder="Amount (KAS)" class="amount-input" required>
                    <button type="button" class="btn btn-danger remove-dest">Remove</button>
                  </div>
                </div>
                <button type="button" id="add-destination" class="btn btn-secondary">+ Add Destination</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Total Amount: <span id="total-amount">0.00000000</span> KAS</label>
          </div>
          <button type="submit" class="btn btn-primary">Create Session</button>
        </form>
      </div>

      <!-- Wallet Tab -->
      <div id="wallet-tab" class="tab-content">
        <div id="wallet-not-imported" class="wallet-section wallet-compact">
          <h2>Import Wallet</h2>
          <p style="margin-bottom: 1rem;">Import your wallet using one of the following methods</p>
          
          <!-- Import Method Tabs -->
          <div class="wallet-import-tabs" style="display:flex; gap:8px; margin-bottom:1rem; border-bottom:1px solid rgba(112,199,186,0.3);">
            <button class="wallet-import-tab-btn active" data-method="privatekey" style="padding:8px 16px; background:transparent; border:none; border-bottom:2px solid var(--primary); color:var(--text-primary); cursor:pointer; font-size:0.9rem;">
              Private Key
            </button>
            <button class="wallet-import-tab-btn" data-method="mnemonic" style="padding:8px 16px; background:transparent; border:none; border-bottom:2px solid transparent; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">
              Mnemonic
            </button>
            <button class="wallet-import-tab-btn" data-method="kpub" style="padding:8px 16px; background:transparent; border:none; border-bottom:2px solid transparent; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">
              KPUB/XPUB (Watch-only)
            </button>
          </div>
          
          <!-- Private Key Import -->
          <div id="import-method-privatekey" class="wallet-import-method active">
            <form id="import-wallet-form" class="wallet-form-compact">
              <div class="form-group-compact">
                <label>Private Key (Hex)</label>
                <input type="password" id="private-key-input" placeholder="Enter private key (hex format)" required>
                <small class="helper-text" style="margin-top:4px; display:block; font-size:0.85rem; color:var(--text-secondary);">
                  Enter your 64-character hex private key
                </small>
              </div>
              <button type="submit" class="btn btn-primary">Import Wallet</button>
            </form>
          </div>
          
          <!-- Mnemonic Import -->
          <div id="import-method-mnemonic" class="wallet-import-method" style="display:none;">
            <form id="import-mnemonic-form" class="wallet-form-compact">
              <div class="form-group-compact">
                <label>Mnemonic Phrase (12 or 24 words)</label>
                <textarea id="mnemonic-input" placeholder="Enter your mnemonic phrase (12 or 24 words)" rows="3" style="width:100%; padding:0.75rem; background:rgba(0,0,0,0.2); border:1px solid rgba(112,199,186,0.3); border-radius:8px; color:var(--text-primary); font-family:inherit; resize:vertical;" required></textarea>
                <small class="helper-text" style="margin-top:4px; display:block; font-size:0.85rem; color:var(--text-secondary);">
                  Enter your 12 or 24-word mnemonic seed phrase (BIP39 format)
                </small>
              </div>
              <div class="form-group-compact">
                <label>Passphrase (Optional)</label>
                <input type="password" id="mnemonic-passphrase-input" placeholder="Optional passphrase" style="width:100%;">
                <small class="helper-text" style="margin-top:4px; display:block; font-size:0.85rem; color:var(--text-secondary);">
                  Additional passphrase for your mnemonic (leave empty if not used)
                </small>
              </div>
              <button type="submit" class="btn btn-primary">Import Wallet from Mnemonic</button>
            </form>
          </div>
          
          <!-- KPUB/XPUB Import (Watch-only) -->
          <div id="import-method-kpub" class="wallet-import-method" style="display:none;">
            <form id="import-kpub-form" class="wallet-form-compact">
              <div class="form-group-compact">
                <label>Extended Public Key (KPUB/XPUB)</label>
                <input type="text" id="kpub-input" placeholder="Enter KPUB or XPUB (kpub... or xpub...)" style="width:100%;" required>
                <small class="helper-text" style="margin-top:4px; display:block; font-size:0.85rem; color:var(--text-secondary);">
                  Enter your extended public key to generate watch-only addresses
                </small>
              </div>
              <div class="form-group-compact" style="display:flex; gap:12px;">
                <div style="flex:1;">
                  <label>Start Index</label>
                  <input type="number" id="kpub-start-index" value="0" min="0" style="width:100%;">
                </div>
                <div style="flex:1;">
                  <label>Count</label>
                  <input type="number" id="kpub-count" value="10" min="1" max="100" style="width:100%;">
                </div>
              </div>
              <div style="display:flex; gap:8px;">
                <button type="submit" class="btn btn-primary" style="flex:1;">Generate Addresses</button>
                <button type="button" id="clear-kpub-results" class="btn btn-secondary" style="display:none;">Clear</button>
              </div>
              <div id="kpub-addresses-result" style="margin-top:1rem; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                  <h4 style="margin:0; font-size:1rem;">Generated Addresses:</h4>
                  <button type="button" id="clear-kpub-results-inline" class="btn btn-secondary btn-sm">Clear Results</button>
                </div>
                <div id="kpub-addresses-list" style="background:rgba(0,0,0,0.2); border:1px solid rgba(112,199,186,0.3); border-radius:8px; padding:0.75rem; max-height:300px; overflow-y:auto;"></div>
              </div>
            </form>
          </div>
        </div>

        <div id="wallet-imported" class="wallet-grid-container hidden">
          <!-- Balance Card -->
          <div class="wallet-card wallet-balance-card collapsible-section">
            <div class="wallet-card-header collapsible-header" data-target="wallet-balance-content">
              <h3>Balance</h3>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <div class="wallet-card-actions">
                  <button id="refresh-balance" class="btn btn-secondary btn-sm">Refresh</button>
                  <button id="wallet-remove-inline" class="btn btn-danger btn-sm">Remove</button>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="collapsible-content" id="wallet-balance-content">
              <div class="wallet-balance-display">
                <span id="balance-amount" class="balance-value-compact">Loading...</span>
              </div>
              <div id="balance-breakdown" class="balance-breakdown" style="display:none; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid rgba(255,255,255,0.2);">
                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:0.5rem;">
                  <span style="color:rgba(255,255,255,0.8);">Confirmed:</span>
                  <span id="balance-confirmed" style="color:rgba(255,255,255,0.95); font-weight:500;">0 KAS</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:0.5rem;">
                  <span style="color:rgba(255,255,255,0.8);">Pending:</span>
                  <span id="balance-pending" style="color:rgba(255,255,255,0.95); font-weight:500;">0 KAS</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
                  <span style="color:rgba(255,255,255,0.8);">Mature:</span>
                  <span id="balance-mature" style="color:rgba(255,255,255,0.95); font-weight:500;">0 KAS</span>
                </div>
                <div id="balance-last-updated" style="font-size:0.75rem; color:rgba(255,255,255,0.7); margin-top:0.5rem; text-align:right;"></div>
              </div>
            </div>
          </div>

          <!-- Address Card -->
          <div class="wallet-card wallet-address-card collapsible-section">
            <div class="wallet-card-header collapsible-header" data-target="wallet-address-content">
              <h3>Address</h3>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <button id="copy-wallet-address" class="btn btn-secondary btn-sm">Copy</button>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="collapsible-content" id="wallet-address-content">
              <div class="wallet-address-display">
                <div class="wallet-qr-container">
                  <canvas id="wallet-address-qrcode" class="wallet-qrcode"></canvas>
                </div>
                <div class="wallet-address-text-container">
                  <span id="wallet-address" class="address-text-compact"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- KPUB Card -->
          <div class="wallet-card wallet-kpub-card collapsible-section" id="wallet-kpub-card" style="display:none;">
            <div class="wallet-card-header collapsible-header" data-target="wallet-kpub-content">
              <h3>Extended Public Key (KPUB)</h3>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <button id="copy-wallet-kpub" class="btn btn-secondary btn-sm" style="display:none;">Copy</button>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="collapsible-content" id="wallet-kpub-content">
              <div class="wallet-kpub-display">
                <span id="wallet-kpub" class="address-text-compact" style="font-size:0.85rem; word-break:break-all;"></span>
                <div id="wallet-kpub-note" class="helper-text" style="margin-top:0.75rem; font-size:0.8rem; line-height:1.5;"></div>
              </div>
            </div>
          </div>

          <!-- Send Funds Card -->
          <div class="wallet-card wallet-send-card collapsible-section">
            <div class="wallet-card-header collapsible-header" data-target="wallet-send-content">
              <h3>Send Funds</h3>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content" id="wallet-send-content">
              <form id="send-funds-form" class="wallet-form-compact">
                <div class="form-group-compact">
                  <label>To Address</label>
                  <div style="display:flex; gap:0.5rem;">
                    <input type="text" id="send-address" placeholder="kaspa:..." required style="flex:1;">
                    <select id="send-address-select" style="padding:0.5rem; border-radius:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(112,199,186,0.2); color:var(--text-primary); min-width:120px;">
                      <option value="">From Address Book</option>
                    </select>
                  </div>
                </div>
                <div class="form-group-compact">
                  <label>Amount (KAS)</label>
                  <input type="number" step="0.00000001" min="0.00001" id="send-amount" placeholder="0.00" required>
                </div>
                <!-- Fee Estimation Display -->
                <div id="fee-estimation" class="fee-estimation" style="display:none; margin-bottom:1rem; padding:0.75rem; background:rgba(0,0,0,0.2); border-radius:8px; border:1px solid rgba(112,199,186,0.2);">
                  <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:0.5rem;">
                    <span style="color:var(--text-secondary);">Estimated Fee:</span>
                    <span id="estimated-fee-amount" style="color:#70c7ba; font-weight:500;">0 KAS</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:0.5rem;">
                    <span style="color:var(--text-secondary);">Total Cost:</span>
                    <span id="total-cost-amount" style="color:#fff; font-weight:500;">0 KAS</span>
                  </div>
                  <div id="fee-warning" style="display:none; font-size:0.8rem; color:#ffc107; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid rgba(255,193,7,0.3);"></div>
                </div>
                <button type="submit" class="btn btn-primary">Send</button>
              </form>
            </div>
          </div>

          <!-- Transaction History Card -->
          <div class="wallet-card wallet-history-card collapsible-section" style="grid-column: 1 / -1;">
            <div class="wallet-card-header collapsible-header" data-target="wallet-history-content">
              <h3>Transaction History</h3>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <div class="wallet-card-actions">
                  <button id="refresh-transactions" class="btn btn-secondary btn-sm">Refresh</button>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="collapsible-content" id="wallet-history-content">
              <div id="transaction-history-container" style="max-height:500px; overflow-y:auto;">
                <div id="transaction-history-list" class="transaction-history-list">
                  <div style="text-align:center; padding:2rem; color:var(--text-secondary);">Loading transactions...</div>
                </div>
              </div>
              <div id="transaction-history-pagination" style="display:none; margin-top:1rem; padding-top:1rem; border-top:1px solid rgba(112,199,186,0.2); text-align:center;">
                <button id="load-more-transactions" class="btn btn-secondary btn-sm">Load More</button>
                <div id="transaction-history-info" style="font-size:0.85rem; color:var(--text-secondary); margin-top:0.5rem;"></div>
              </div>
            </div>
          </div>

          <!-- Address Book Card -->
          <div class="wallet-card wallet-addressbook-card collapsible-section" style="grid-column: 1 / -1;">
            <div class="wallet-card-header collapsible-header" data-target="wallet-addressbook-content">
              <h3>Address Book</h3>
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <div class="wallet-card-actions">
                  <button id="refresh-addressbook" class="btn btn-secondary btn-sm">Refresh</button>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="collapsible-content" id="wallet-addressbook-content">
              <!-- Add Address Form -->
              <form id="addressbook-add-form" class="wallet-form-compact" style="margin-bottom:1.5rem; padding:1rem; background:rgba(0,0,0,0.1); border-radius:8px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1rem;">
                  <div class="form-group-compact">
                    <label>Address</label>
                    <input type="text" id="addressbook-address" placeholder="kaspa:..." required>
                  </div>
                  <div class="form-group-compact">
                    <label>Label</label>
                    <input type="text" id="addressbook-label" placeholder="My Wallet / Exchange" required>
                  </div>
                </div>
                <div class="form-group-compact" style="margin-bottom:1rem;">
                  <label>Category (optional)</label>
                    <select id="addressbook-category" style="width:100%; padding:0.5rem; border-radius:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(112,199,186,0.2); color:var(--text-primary);">
                      <option value="General">General</option>
                      <option value="Personal">Personal</option>
                      <option value="Exchange">Exchange</option>
                      <option value="Mining Pool">Mining Pool</option>
                      <option value="Merchant">Merchant</option>
                      <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Address</button>
              </form>

              <!-- Address List -->
              <div id="addressbook-list" style="max-height:400px; overflow-y:auto;">
                <div style="text-align:center; padding:2rem; color:var(--text-secondary);">No addresses saved. Add your first address above.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mining Pool Tab -->
      <div id="pool-tab" class="tab-content">
        <div class="pool-content-wrapper">
          <div class="sessions-list pool-grid-top" style="margin-top: 0;">
            <div class="session-card pool-card collapsible-section">
              <div class="session-header collapsible-header" data-target="pool-settings-panel">
                <div>
                  <div class="session-id">Settings</div>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="session-details collapsible-content" id="pool-settings-panel">
                <div class="form-group">
                  <label>Port</label>
                  <input type="number" id="pool-port" value="7777" min="1" max="65535" />
                </div>
                <div class="form-group">
                  <label>Difficulty</label>
                  <input type="number" id="pool-difficulty" value="1" min="1" step="1" />
                  <div class="asic-guidance" style="margin-top:10px;">
                    <div style="margin-bottom:8px; font-size:0.85rem; font-weight:500;" class="helper-text">
                      <strong>ASIC Quick Select:</strong> Click to set recommended difficulty
                    </div>
                    <div class="asic-buttons">
                      <button type="button" class="asic-chip" data-difficulty="256" data-model="KS0/KS0 Pro/KS0 Ultra">
                        <span class="asic-model">KS0 Series</span>
                        <span class="asic-range">256‚Äì1024</span>
                      </button>
                      <button type="button" class="asic-chip" data-difficulty="1024" data-model="KS1/KS2/KS2Lite">
                        <span class="asic-model">KS1/KS2/KS2Lite</span>
                        <span class="asic-range">1024‚Äì4096</span>
                      </button>
                      <button type="button" class="asic-chip" data-difficulty="4096" data-model="KS3L/KS3M/KS3 Pro">
                        <span class="asic-model">KS3L/KS3M/KS3 Pro</span>
                        <span class="asic-range">4096‚Äì16384</span>
                      </button>
                      <button type="button" class="asic-chip" data-difficulty="16384" data-model="KS3/KS5L/KS5M/KS7">
                        <span class="asic-model">KS3/KS5/KS7 Series</span>
                        <span class="asic-range">16384‚Äì32768</span>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Vardiff Settings -->
                <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                  <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="pool-vardiff-enabled" style="width: auto; cursor: pointer;" />
                    <span>Enable Variable Difficulty (Vardiff)</span>
                  </label>
                  <div class="helper-text" style="margin-top:4px; font-size:0.85rem;">
                    Automatically adjust difficulty per miner based on hashrate
                  </div>
                  
                  <!-- Vardiff Advanced Settings (hidden by default) -->
                  <div id="vardiff-settings" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                      <label>Target Time Between Shares (seconds)</label>
                      <input type="number" id="vardiff-target-time" value="30" min="5" max="300" step="1" />
                      <div class="helper-text" style="margin-top:4px; font-size:0.85rem;">
                        Target time between share submissions (default: 30s)
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                      <div class="form-group">
                        <label>Min Difficulty</label>
                        <input type="number" id="vardiff-min-difficulty" value="64" min="1" step="1" />
                      </div>
                      <div class="form-group">
                        <label>Max Difficulty</label>
                        <input type="number" id="vardiff-max-difficulty" value="65536" min="1" step="1" />
                      </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                      <div class="form-group">
                        <label>Max Change Multiplier</label>
                        <input type="number" id="vardiff-max-change" value="2.0" min="1.1" max="10" step="0.1" />
                        <div class="helper-text" style="margin-top:4px; font-size:0.85rem;">
                          Max difficulty change per adjustment (default: 2.0x)
                        </div>
                      </div>
                      <div class="form-group">
                        <label>Change Interval (seconds)</label>
                        <input type="number" id="vardiff-change-interval" value="30" min="10" max="300" step="1" />
                        <div class="helper-text" style="margin-top:4px; font-size:0.85rem;">
                          Minimum time between adjustments (default: 30s)
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="session-card pool-card collapsible-section">
              <div class="session-header collapsible-header" data-target="pool-treasury-panel">
                <div>
                  <div class="session-id">Treasury & Threshold</div>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="session-details collapsible-content" id="pool-treasury-panel">
                <div class="form-group">
                  <label>Payment Threshold (KAS)</label>
                  <input type="number" id="pool-threshold-kas" value="10" min="0" step="0.00000001" />
                  <div class="helper-text" style="margin-top:4px; font-size:0.85rem;">
                    Payout when balance exceeds this threshold
                  </div>
                </div>
                <div class="form-group" style="margin-top:1.5rem; padding-top:1.5rem; border-top:1px solid rgba(255,255,255,0.1);">
                  <label>Payment Interval (Hours) <small class="helper-text" style="font-weight:400;">(Optional - Time-based payout)</small></label>
                  <div style="display:flex; gap:8px; align-items:center;">
                    <select id="pool-payment-interval" style="flex:1;">
                      <option value="">Disabled (threshold only)</option>
                      <option value="4">4 hours</option>
                      <option value="6">6 hours</option>
                      <option value="8">8 hours</option>
                      <option value="12">12 hours</option>
                      <option value="24">24 hours</option>
                      <option value="48">48 hours</option>
                      <option value="72">72 hours (3 days)</option>
                      <option value="168">168 hours (7 days)</option>
                      <option value="custom">Custom...</option>
                    </select>
                    <input type="number" id="pool-payment-interval-custom" value="" min="1" max="168" step="1" placeholder="Hours" style="flex:0 0 100px; display:none;" />
                  </div>
                  <div class="helper-text" style="margin-top:4px; font-size:0.85rem; line-height:1.4;">
                    Payouts occur when <strong>either</strong> threshold is reached <strong>or</strong> time interval elapses (whichever comes first)
                  </div>
                </div>
                <div class="form-group" id="pool-miner-settings" style="display:none; margin-top:1rem; padding:1rem; background:rgba(0,0,0,0.2); border-radius:8px; border:1px solid rgba(112,199,186,0.2);">
                  <div style="margin-bottom:0.75rem;">
                    <strong style="font-size:0.9rem;">Miner Payment Settings</strong>
                    <div class="helper-text" style="font-size:0.85rem; margin-top:4px;">
                      Configure payout settings for your miner address
                    </div>
                  </div>
                  <div class="form-group" style="margin-bottom:0.75rem;">
                    <label style="font-size:0.9rem;">Your Miner Address</label>
                    <input type="text" id="pool-miner-address" placeholder="kaspa:..." style="font-family:ui-monospace,Menlo,Consolas,'Courier New',monospace; font-size:0.9rem;" />
                  </div>
                  <div class="form-group" style="margin-bottom:0.75rem;">
                    <label style="font-size:0.9rem;">Verification IP (Your Public IP)</label>
                    <input type="text" id="pool-verification-ip" placeholder="Your public IP address" style="font-family:ui-monospace,Menlo,Consolas,'Courier New',monospace; font-size:0.9rem;" />
                    <div class="helper-text" style="font-size:0.8rem; margin-top:4px; line-height:1.4;">
                      Your public IP address that the pool sees when you're mining. This must match the IP address your mining device uses to connect to the pool for security verification. You can find this by checking your router or using an online service like "what is my ip".
                    </div>
                  </div>
                  <div style="display:flex; gap:8px;">
                    <button id="pool-save-payment-interval" class="btn btn-primary" style="flex:1;">Save Payment Interval</button>
                    <button id="pool-get-miner-info" class="btn btn-secondary" style="flex:1;">Get My Settings</button>
                  </div>
                  <div id="pool-miner-info-display" style="margin-top:1rem; padding:0.75rem; background:rgba(0,0,0,0.3); border-radius:6px; display:none;">
                    <div style="font-size:0.9rem;">
                      <div style="margin-bottom:0.5rem;"><strong>Current Settings:</strong></div>
                      <div id="pool-miner-info-content" style="font-family:ui-monospace,Menlo,Consolas,'Courier New',monospace; font-size:0.85rem; line-height:1.6;"></div>
                    </div>
                  </div>
                </div>
                <button id="pool-toggle-miner-settings" class="btn btn-secondary" style="margin-top:1rem; width:100%;">Configure Miner Payment Settings</button>
                <div class="form-group">
                  <label>Treasury Private Key <small id="pool-key-status" class="helper-text" style="font-weight:400;">(not configured)</small></label>
                  
                  <!-- Current Key Display (hidden by default, click to reveal) -->
                  <div id="pool-current-key-display" style="display:none; margin-bottom:1rem; padding:0.75rem; background:rgba(0,0,0,0.2); border-radius:8px; border:1px solid rgba(112,199,186,0.2);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                      <strong style="font-size:0.9rem;">Current Private Key:</strong>
                      <button id="pool-toggle-key-visibility" class="btn btn-secondary" style="padding:4px 12px; font-size:0.85rem;">
                        <span id="pool-key-toggle-text">Show</span>
                      </button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                      <code id="pool-current-key-value" style="flex:1; font-size:0.85rem; word-break:break-all; color:var(--text-secondary); font-family:ui-monospace,Menlo,Consolas,'Courier New',monospace;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
                      <button id="pool-copy-current-key" class="btn btn-secondary" style="padding:4px 12px; font-size:0.85rem;">Copy</button>
                    </div>
                  </div>
                  
                  <div style="display:flex; gap:8px; align-items:center;">
                    <input type="password" id="pool-treasury-key" placeholder="Paste private key (hex)" style="flex:1;" />
                    <button id="pool-generate-key" class="btn btn-secondary">Generate</button>
                    <button id="pool-save-key" class="btn btn-secondary">Save</button>
                  </div>
                  <div id="pool-generated-key-info" class="generated-key-info" style="display:none;">
                    <div style="margin-bottom:8px;">
                      <strong>Generated Address:</strong>
                      <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                        <code id="pool-generated-address" style="flex:1; font-size:0.9rem; word-break:break-all;"></code>
                        <button id="pool-copy-address" class="btn btn-secondary" style="padding:6px 12px; font-size:0.85rem;">Copy</button>
                      </div>
                    </div>
                    <div style="margin-bottom:8px;">
                      <strong>Private Key:</strong>
                      <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                        <code id="pool-generated-key" style="flex:1; font-size:0.9rem; word-break:break-all;"></code>
                        <button id="pool-copy-key" class="btn btn-secondary" style="padding:6px 12px; font-size:0.85rem;">Copy</button>
                        <button id="pool-use-key" class="btn btn-primary" style="padding:6px 12px; font-size:0.85rem;">Use This Key</button>
                      </div>
                    </div>
                    <div class="warning-text" style="font-size:0.85rem; margin-top:6px;">
                      ‚ö† <strong>Important:</strong> Save this private key securely! You will need it to access any funds sent to this address.
                    </div>
                  </div>
                  <div class="helper-text" style="margin-top:6px; font-size:0.85rem; line-height:1.3;">
                    This key authorizes the pool's treasury to send rewards. Payouts are
                    generated by the pool and transferred to the miner's Kaspa address configured
                    in your mining software. Keep this key secure.
                  </div>
                  <div class="warning-text" style="margin-top:8px; font-size:0.85rem; line-height:1.4; padding:0.75rem; background:rgba(255,193,7,0.1); border-left:3px solid #ffc107; border-radius:4px;">
                    <strong>‚ö†Ô∏è Important:</strong> Only generate a new private key if you haven't configured one yet, or if you need to create a new treasury address. Generating a new key will create a different address, and any funds sent to the previous address will not be accessible with the new key. Make sure to backup your private key before generating a new one.
                  </div>
                </div>
              </div>
            </div>

            <div class="session-card pool-card full collapsible-section">
              <div class="session-header collapsible-header" data-target="pool-controls-panel">
                <div>
                  <div class="session-id">Controls</div>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="session-details collapsible-content" id="pool-controls-panel">
                <div class="detail-row" style="align-items:center;">
                  <span class="detail-label">Status:</span>
                  <span id="pool-status-text">Stopped</span>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="pool-start" class="btn btn-primary">Start</button>
                  <button id="pool-stop" class="btn btn-danger">Stop</button>
                </div>
                <div style="margin-top:0.5rem;">
                  <button id="pool-force-payout" class="btn btn-secondary" style="width:100%;" title="Force payout to all miners with balance > 0 (ignores thresholds)">Force Payout All Miners</button>
                </div>
              </div>
            </div>
          </div>
          <div class="sessions-list pool-grid">
            <div class="session-card connect-card collapsible-section">
              <div class="session-header collapsible-header" data-target="pool-stats-panel">
                <div>
                  <div class="session-id">Pool Stats</div>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="session-details collapsible-content" id="pool-stats-panel">
                <div class="detail-row"><span class="detail-label">Network:</span><span id="pool-network">-</span></div>
                <div class="detail-row"><span class="detail-label">Miners:</span><span id="pool-miners">0</span></div>
                <div class="detail-row"><span class="detail-label">Workers:</span><span id="pool-workers">0</span></div>
                <div class="detail-row"><span class="detail-label">Active Connections:</span><span id="pool-connections">0</span></div>
                <div class="detail-row"><span class="detail-label">Pool Hashrate:</span><span id="pool-hashrate">0 H/s</span></div>
                <div class="detail-row"><span class="detail-label">Blocks Found:</span><span id="pool-blocks-found">0</span></div>
              </div>
            </div>
            <div class="session-card collapsible-section">
              <div class="session-header collapsible-header" data-target="pool-connect-panel">
                <div>
                  <div class="session-id">How to Connect</div>
                </div>
                <span class="collapse-icon">‚ñº</span>
              </div>
              <div class="session-details collapsible-content" id="pool-connect-panel" style="display:flex; flex-direction:column; gap:10px;">
                <div>
                  <div class="detail-label" style="margin-bottom:6px;">Local PC (this machine)</div>
                  <div class="code-box"><code id="pool-connect-local">stratum+tcp://127.0.0.1:7777</code></div>
                </div>
                <div>
                  <div class="detail-label" style="margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Click Auto-detect to get your PC's IP address</span>
                    <button id="pool-detect-ip" class="btn btn-secondary" style="padding:4px 12px; font-size:0.85rem;">
                      Auto-Detect IP
                    </button>
                  </div>
                  <div class="code-box"><code id="pool-connect-lan">stratum+tcp://YOUR_PC_IP:7777</code></div>
                </div>
                <div>
                  <div class="detail-label" style="margin-bottom:6px;">Username (wallet address and optional worker)</div>
                  <div class="code-box"><code>kaspa:&lt;your_payout_address&gt;[.worker]</code></div>
                </div>
                <div>
                  <div class="detail-label" style="margin-bottom:6px;">Password</div>
                  <div class="code-box"><code>x</code></div>
                </div>
                <div style="font-size:0.85rem;" class="helper-text">
                  Tip: On ASICs, set URL to the LAN value (your PC's IP) and use your Kaspa payout address as the username.
                </div>
              </div>
            </div>
          </div>
          <!-- Pool Dashboard: Workers -->
          <div class="session-card pool-card full collapsible-section">
            <div class="session-header collapsible-header" data-target="pool-workers-panel">
              <div>
                <div class="session-id">Active Workers Dashboard</div>
              </div>
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <button id="refresh-workers" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Refresh</button>
                <span class="collapse-icon">‚ñº</span>
              </div>
            </div>
            <div class="session-details collapsible-content" id="pool-workers-panel">
              <div id="workers-list" class="workers-list">
                <div class="loading">No active workers. Start mining to see workers here.</div>
              </div>
            </div>
          </div>

          <div class="collapsible-section">
            <div class="collapsible-header" data-target="pool-output-panel">
              <h3>Recent Output</h3>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="collapsible-content debug-info" id="pool-output-panel">
              <pre id="pool-output"></pre>
            </div>
          </div>
        </div>
      </div>
      </div>
      
    </main>

    <!-- Status Messages -->
    <div id="status-message" class="status-message hidden"></div>
    
    <!-- Block Found Notification Popup -->
    <div id="block-notification-container" class="block-notification-container"></div>
  </div>

  <script src="renderer.js"></script>
</body>
</html>

